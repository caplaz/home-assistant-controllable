name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev
          pip install --prefer-binary -r requirements-dev.txt

      - name: Check code formatting with Black
        run: black --check --diff custom_components/

      - name: Check import sorting with isort
        run: isort --check-only --diff custom_components/

      - name: Lint with flake8
        run: |
          flake8 custom_components/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 custom_components/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Type checking with mypy
        run: mypy custom_components/ --ignore-missing-imports

  validate:
    name: Home Assistant Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate HACS
        uses: hacs/action@main
        with:
          category: integration

      - name: Validate with hassfest
        uses: home-assistant/actions/hassfest@master

      - name: Validate Custom Component Structure
        run: |
          if [ ! -f custom_components/controllable/__init__.py ]; then
            echo "Missing __init__.py"
            exit 1
          fi

          if [ ! -f custom_components/controllable/manifest.json ]; then
            echo "Missing manifest.json"
            exit 1
          fi

          python -c "
          import json
          import sys

          try:
              with open('custom_components/controllable/manifest.json') as f:
                  manifest = json.load(f)

              required_fields = ['domain', 'name', 'version', 'documentation', 'issue_tracker', 'requirements', 'codeowners']
              missing_fields = [field for field in required_fields if field not in manifest]

              if missing_fields:
                  print(f'Missing required manifest fields: {missing_fields}')
                  sys.exit(1)

              print('Custom component validation passed')
          except Exception as e:
              print(f'Manifest validation failed: {e}')
              sys.exit(1)
          "

      - name: Test Component Import
        run: |
          python -m pip install --upgrade pip
          pip install homeassistant==2024.1.0
          pip install voluptuous>=0.13.1

          export PYTHONPATH="${PWD}:${PYTHONPATH}"
          python -c "
          import sys
          sys.path.insert(0, 'custom_components')

          try:
              from controllable.const import DOMAIN
              print(f'✅ Component import successful, domain: {DOMAIN}')

              from controllable.config_flow import ControllableConfigFlow
              print('✅ Config flow import successful')

              from controllable.switch import ControllableSwitch
              print('✅ Switch entity import successful')

          except Exception as e:
              print(f'❌ Component import failed: {e}')
              sys.exit(1)
          "

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
        home-assistant-version: ["2024.1.0"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Home Assistant ${{ matrix.home-assistant-version }}
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev libffi-dev libssl-dev pkg-config
          pip install --upgrade setuptools wheel
          pip install --only-binary=aiohttp,yarl,multidict homeassistant==${{ matrix.home-assistant-version }}

      - name: Install dev dependencies
        run: pip install --only-binary=all -r requirements-dev.txt

      - name: Run tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}"
          python -m pytest tests/ -v --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}

      if: always()

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bandit
        run: pip install bandit

      - name: Run security scan
        run: bandit -r custom_components/ -f json -o bandit-report.json

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README.md
        run: |
          if [ ! -f README.md ]; then
            echo "README.md is missing"
            exit 1
          fi

          if ! grep -q "## Installation" README.md; then
            echo "README.md missing Installation section"
            exit 1
          fi

          if ! grep -q "## Configuration" README.md; then
            echo "README.md missing Configuration section"
            exit 1
          fi

      - name: Check manifest.json
        run: |
          python -c "
          import json
          with open('custom_components/controllable/manifest.json') as f:
              manifest = json.load(f)

          required_fields = ['domain', 'name', 'version', 'codeowners', 'documentation', 'issue_tracker']
          for field in required_fields:
              if field not in manifest:
                  print(f'Missing required field: {field}')
                  exit(1)

          print('manifest.json validation passed')
          "

      - name: Validate CHANGELOG.md
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md is missing"
            exit 1
          fi

          if ! grep -q "## " CHANGELOG.md; then
            echo "CHANGELOG.md appears to be empty or improperly formatted"
            exit 1
          fi

  release-check:
    name: Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [lint, validate, test, security, documentation]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version consistency
        run: |
          MANIFEST_VERSION=$(python -c "
          import json
          with open('custom_components/controllable/manifest.json') as f:
              print(json.load(f)['version'])
          ")

          echo "Manifest version: $MANIFEST_VERSION"
          echo "Version consistency check passed (no version.py)"

      - name: Generate release notes
        run: |
          echo "## Release Summary" > release_notes.md
          echo "" >> release_notes.md
          echo "### Changes in this release:" >> release_notes.md
          git log --oneline --since="1 week ago" >> release_notes.md

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md